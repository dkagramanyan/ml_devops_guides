# Mikrotik

Настройка NAT: Hairpin
----------------------

Если у вас есть белвый ip, то вы можете настроить проброс портов и работать в jupyter сервером удаленно. Важно!
Обязательно нужно использовать SSL сертификат

Для настройки был взят вот этот [гайд](https://spw.ru/educate/articles/natpart5/)

Пусть ваш белвый ip это 100.100.100.100, локальная сеть имеет такие адреса 192.168.88.xxx/24, адрес компьютера 192.168.88.53 и порт, на котором запущен юпитер, 8888. 


1)  Созданим правило переадресации, по которому входящие запросы переадресовываются на компьютер с адресом 192.168.88.53. 

~~~
/ip firewall nat
add action=dst-nat chain=dstnat dst-address=100.100.100.100 dst-port=443 protocol=tcp \
to-addresses=192.168.88.53 to-port=8888
~~~

2) Адрес переадресованного запроса менется на адрес маршрутизатора 192.168.88.1. Затем запрос окончательно уходит к компьютеру 

~~~
add action=masquerade chain=srcnat dst-address=192.168.88.53 dst-port=8888 protocol=tcp \
src-address=192.168.88.0/24
~~~

Проброс портов для SSH
----------------------

Для проброса порта нужно создать в FireWall новое [правило](https://forum.mikrotik.com/viewtopic.php?t=136405). Важно! С этим правилом можно присоединиться из вне локальной сети машины. Если попытаться подключаться в ее локальной сети, то подлюкчения не будет
~~~
/ip firewall nat
add action=dst-nat chain=dstnat dst-port=1234 protocol=tcp to-addresses=192.168.88.53 to-ports=22
~~~

Для решения проблемы нужно взять правило из второй части [гайда](https://spw.ru/educate/articles/natpart5/):
~~~
add action=masquerade chain=srcnat dst-address=192.168.88.53 dst-port=1234 protocol=tcp \
src-address=192.168.88.0/24
~~~


Настройка DNS доменов
----------------------

1) ip->DNS->Static
2) добавляем название домена и адрес


Изменение ip адресов в dhcp сервере
----------------------------------

1) quick setup
2) меняем адрес роутера и диапазон ip адресов ниже
3) обязательно! переподключаемся к сети. Без этого не получится подключиться к роутеру через веб/winbox


Настройка двух провайдеров
--------------------------

Еще не дописано, пока алгоритм не рабочий

1) все порты, куда воткнута витая пара провадйеров, должны находиться вне Bridge
2) в addresses list добавляется айпи адрес и указывается порт. Нужно указать только айпи адрес и маску в формате ip/24, где 24 это маска 255.255.255.0 и 22 это маска 255.255.252.0
3) в route list добавляется route c dst.address 0.0.0.0/0, шлюзом провайдера и приоритетом в distance. Чем больше distance, тем ниже приоритет рутинга
4) в DNS добавляются все ip DNS серверов провайдеров
5) в firewall nat добавляется правило chain, выходной интерфейс ether2, список выходных интерфеймов WAN, действие masquerade
